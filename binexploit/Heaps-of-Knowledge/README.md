#Heaps of Knowledge - 400 Points

We were given a binary. We run it to see what it does.
It prompts you for a book name, then there are three options:
1) Create a chapter
2) Delete a chapter
3) Publish

```
Please enter the title of the book you would like to write: AAAA
You have started writing the book 'AAAA'. Please select an option to get started!
1. Edit chapter
2. Delete chapter
3. Publish book
```

After experimenting with this program, you find out that you can only create a chapter starting from 1, 2, 3 and so on. Also you can only delete an existing chapter otherwise the program will exit. Then, publish prints the title, and the content of each chapter. Then, if you edit an existing chapter, it changes it's content.

Because this problem is called Heaps of Knowledge, we can be fairly certain this will be a heap exploit.
We can run this in gdb, enter a random book title, let's say "AAAA" then view our heap using:

>info proc mappings
>x/50wx 0x804c000

```
(gdb) x/50wx 0x804c000
0x804c000:      0x00000000      0x00000011      0x0804c018      0x00000000
0x804c010:      0x00000000      0x00000011      0x41414141      0x00000000
0x804c020:      0x00000000      0x00020fe1      0x00000000      0x00000000
0x804c030:      0x00000000      0x00000000      0x00000000      0x00000000
```

We can see that the first section consists of an address to the actual title of the book, contained in another section. Let's do the same after adding a couple of chapters. Let's set chapter 1's name to BBBB, and it's content to CCCC while chapter 2's name to DDDD and it's content to EEEE

```
0x804c000:      0x00000000      0x00000011      0x0804c018      0x00000002
0x804c010:      0x0804c028      0x00000011      0x41414141      0x00000000
0x804c020:      0x00000000      0x00000019      0x00000000      0x0804c060
0x804c030:      0x0804c040      0x0804c050      0x0804872f      0x00000011
0x804c040:      0x42424242      0x0000000a      0x00000000      0x00000011
0x804c050:      0x43434343      0x0000000a      0x00000000      0x00000019
0x804c060:      0x0804c028      0x00000000      0x0804c078      0x0804c088
0x804c070:      0x0804872f      0x00000011      0x44444444      0x0000000a
0x804c080:      0x00000000      0x00000011      0x45454545      0x0000000a
0x804c090:      0x00000000      0x00020f71      0x00000000      0x00000000
```

We can see that this is very siilar in structure. The section containing addresses for chapters, however, contains three addresses: the chapter's name, chapter's content, and huh? what is the last one? We can quickly view it using

>x 0x0804872f

```
0x804872f <print_chapter>:      0x83e58955
```

We see that this is an address pointing to the function to print this chapter. From this knowledge, we can surmise that the edit chapter edits content at the chapter's content's address (for chapter 1 in this case, it is 0x0804c050). Then the publish function most likely calls the function at the print chapter address stored on the heap. (for chapter 1 it is 0x0804872f).

Next, we look into the disassembly of the binary.

